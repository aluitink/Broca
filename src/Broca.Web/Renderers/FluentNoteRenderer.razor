@using KristofferStrube.ActivityStreams
@using Microsoft.FluentUI.AspNetCore.Components
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@using Broca.ActivityPub.Components.Services
@inherits ComponentBase

<FluentCard Class="@($"fluent-note-card {CssClass}")">
    @if (Note != null)
    {
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
            @* Header with actor and timestamp *@
            <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" class="note-header">
                @if (ShowActor && Note.AttributedTo?.Any() == true)
                {
                    <FluentPersona Name="@GetActorDisplay()"
                                   Image="@GetActorImageUrl()"
                                   ImageSize="32px"
                                   TextPosition="@TextPosition.End">
                        @if (!string.IsNullOrEmpty(GetActorUsername()))
                        {
                            <FluentLabel Typo="Typography.Body" Color="Color.Neutral">
                                @@@GetActorUsername()
                            </FluentLabel>
                        }
                    </FluentPersona>
                }
                
                @if (Note.Published.HasValue)
                {
                    <FluentLabel Typo="Typography.Body" Color="Color.Neutral" class="note-timestamp">
                        <time datetime="@Note.Published.Value.ToString("o")" title="@Note.Published.Value.ToString("f")">
                            @FormatDateTime(Note.Published.Value)
                        </time>
                    </FluentLabel>
                }
            </FluentStack>

            @* Title *@
            @if (Note.Name?.Any() == true)
            {
                <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold" class="note-title">
                    @Note.Name.First()
                </FluentLabel>
            }

            @* Content *@
            @if (Note.Content?.Any() == true)
            {
                <div class="note-content">
                    @((MarkupString)(Note.Content.First() ?? string.Empty))
                </div>
            }

            @* Attachments *@
            @if (Note.Attachment?.Any() == true)
            {
                <FluentStack Orientation="Orientation.Horizontal" Wrap="true" class="note-attachments">
                    @foreach (var attachment in Note.Attachment)
                    {
                        <div class="attachment-item">
                            @RenderAttachment(attachment)
                        </div>
                    }
                </FluentStack>
            }

            @* Actions *@
            @if (ShowActions)
            {
                <FluentDivider Style="margin: 0;" />
                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="4" class="note-actions">
                    <FluentButton Appearance="Appearance.Lightweight" 
                                  IconStart="@(new Icons.Regular.Size16.ArrowReply())"
                                  OnClick="@(() => OnReply.InvokeAsync(Note))">
                        Reply
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Lightweight" 
                                  IconStart="@(new Icons.Regular.Size16.ArrowRepeatAll())"
                                  OnClick="@(() => OnBoost.InvokeAsync(Note))">
                        Boost
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Lightweight" 
                                  IconStart="@(new Icons.Regular.Size16.Heart())"
                                  OnClick="@(() => OnLike.InvokeAsync(Note))">
                        Like
                    </FluentButton>
                </FluentStack>
            }

            @if (AdditionalContent != null)
            {
                @AdditionalContent(Note)
            }
        </FluentStack>
    }
</FluentCard>

@code {
    /// <summary>
    /// Gets or sets the Note object to render.
    /// </summary>
    [Parameter]
    public Note? Note { get; set; }

    /// <summary>
    /// Gets or sets whether to show the actor attribution.
    /// </summary>
    [Parameter]
    public bool ShowActor { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to show action buttons.
    /// </summary>
    [Parameter]
    public bool ShowActions { get; set; } = true;

    /// <summary>
    /// Gets or sets additional CSS classes.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Gets or sets additional content to render.
    /// </summary>
    [Parameter]
    public RenderFragment<Note>? AdditionalContent { get; set; }

    /// <summary>
    /// Event callback for reply action.
    /// </summary>
    [Parameter]
    public EventCallback<Note> OnReply { get; set; }

    /// <summary>
    /// Event callback for boost action.
    /// </summary>
    [Parameter]
    public EventCallback<Note> OnBoost { get; set; }

    /// <summary>
    /// Event callback for like action.
    /// </summary>
    [Parameter]
    public EventCallback<Note> OnLike { get; set; }

    private string GetActorDisplay()
    {
        var actorLink = Note?.AttributedTo?.FirstOrDefault();
        if (actorLink == null) return "Unknown";
        
        // Try to get Name from Actor
        if (actorLink is Actor actor && actor.Name?.Any() == true)
            return actor.Name.First();
        
        // Try to get Name from any Object
        if (actorLink is KristofferStrube.ActivityStreams.Object obj)
        {
            if (obj.Name?.Any() == true)
                return obj.Name.First();
            if (!string.IsNullOrEmpty(obj.Id))
                return obj.Id;
        }
        
        // Try to get Href from Link
        if (actorLink is Link link && link.Href != null)
            return link.Href.ToString();
        
        return "Unknown";
    }

    private string GetActorImageUrl()
    {
        var actorLink = Note?.AttributedTo?.FirstOrDefault();
        if (actorLink == null) return string.Empty;
        
        if (actorLink is Person person && person.Icon?.Any() == true)
        {
            var icon = person.Icon.First();
            if (icon is Image img && img.Url?.Any() == true)
            {
                var url = img.Url.First();
                if (url is Link link && link.Href != null)
                    return link.Href.ToString();
            }
        }
        
        return string.Empty;
    }

    private string GetActorUsername()
    {
        var actorLink = Note?.AttributedTo?.FirstOrDefault();
        if (actorLink == null) return string.Empty;
        
        if (actorLink is Person person && !string.IsNullOrEmpty(person.PreferredUsername))
            return person.PreferredUsername;
        
        return string.Empty;
    }

    private RenderFragment RenderAttachment(IObjectOrLink attachment)
    {
        return builder =>
        {
            if (attachment is Image img)
            {
                builder.OpenElement(0, "img");
                builder.AddAttribute(1, "src", GetImageUrl(img));
                builder.AddAttribute(2, "alt", GetImageAlt(img));
                builder.AddAttribute(3, "loading", "lazy");
                builder.AddAttribute(4, "style", "max-width: 100%; border-radius: 4px;");
                builder.CloseElement();
            }
            else if (attachment is Document doc)
            {
                builder.OpenComponent<FluentButton>(0);
                builder.AddAttribute(1, "Appearance", Appearance.Lightweight);
                builder.AddAttribute(2, "IconStart", new Icons.Regular.Size16.Document());
                builder.AddContent(3, GetDocumentName(doc));
                builder.CloseComponent();
            }
        };
    }

    private string GetImageUrl(Image img)
    {
        var url = img.Url?.FirstOrDefault();
        if (url is Link link && link.Href != null)
            return link.Href.ToString();
        return url?.ToString() ?? string.Empty;
    }

    private string GetImageAlt(Image img)
    {
        return img.Name?.FirstOrDefault() ?? "Image attachment";
    }

    private string GetDocumentName(Document doc)
    {
        return doc.Name?.FirstOrDefault() ?? "Document";
    }

    private string FormatDateTime(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime.ToUniversalTime();
        
        if (timeSpan.TotalMinutes < 1)
            return "just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";
        
        return dateTime.ToString("MMM d, yyyy");
    }
}
