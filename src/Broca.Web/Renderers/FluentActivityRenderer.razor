@using KristofferStrube.ActivityStreams
@using Microsoft.FluentUI.AspNetCore.Components
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@using Broca.ActivityPub.Components
@inherits ComponentBase

<FluentCard Class="@($"fluent-activity-card {CssClass}")">
    @if (Activity != null)
    {
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
            @* Header with actor persona, activity type, and timestamp *@
            <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" class="activity-header">
                @if (!string.IsNullOrEmpty(GetActorId()))
                {
                    <FluentPersona Name="@GetActorName()"
                                   Image="@GetActorImageUrl()"
                                   ImageSize="32px"
                                   TextPosition="@TextPosition.End">
                        @if (!string.IsNullOrEmpty(GetActorUsername()))
                        {
                            <FluentLabel Typo="Typography.Body" Color="Color.Neutral">
                                @@@GetActorUsername()
                            </FluentLabel>
                        }
                    </FluentPersona>
                }
                
                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" VerticalAlignment="VerticalAlignment.Center">
                    <FluentBadge Appearance="Appearance.Accent">
                        @GetActivityTypeIcon() @GetActivityType()
                    </FluentBadge>

                    @if (Activity.Published.HasValue)
                    {
                        <FluentLabel Typo="Typography.Body" Color="Color.Neutral" class="activity-timestamp">
                            <time datetime="@Activity.Published.Value.ToString("o")" title="@Activity.Published.Value.ToString("f")">
                                @FormatDateTime(Activity.Published.Value)
                            </time>
                        </FluentLabel>
                    }
                </FluentStack>
            </FluentStack>

            @* Summary *@
            @if (Activity.Summary?.Any() == true)
            {
                <FluentLabel Typo="Typography.Body" Color="Color.Neutral" Style="font-style: italic;">
                    @Activity.Summary.First()
                </FluentLabel>
            }

            @* Recipients *@
            @if (ShowRecipients && HasRecipients())
            {
                <FluentStack Orientation="Orientation.Horizontal" Wrap="true" HorizontalGap="4">
                    <FluentLabel Typo="Typography.Body" Color="Color.Neutral">
                        <FluentIcon Value="@(new Icons.Regular.Size16.Mail())" />
                        To:
                    </FluentLabel>
                    @RenderRecipients()
                </FluentStack>
            }

            @* Activity Objects *@
            @if (ShowObject && Activity.Object?.Any() == true)
            {
                <FluentDivider Style="margin: 0;" />
                <div class="activity-objects">
                    @foreach (var obj in Activity.Object)
                    {
                        <div class="activity-object">
                            @if (ObjectRenderer != null)
                            {
                                @ObjectRenderer(obj)
                            }
                            else
                            {
                                <ObjectDisplay Object="@obj" />
                            }
                        </div>
                    }
                </div>
            }

            @if (AdditionalContent != null)
            {
                <FluentDivider Style="margin: 0;" />
                @AdditionalContent(Activity)
            }
        </FluentStack>
    }
</FluentCard>

@code {
    /// <summary>
    /// Gets or sets the Activity to render.
    /// </summary>
    [Parameter]
    public Activity? Activity { get; set; }

    /// <summary>
    /// Gets or sets whether to show the activity object(s).
    /// </summary>
    [Parameter]
    public bool ShowObject { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to show the recipients.
    /// </summary>
    [Parameter]
    public bool ShowRecipients { get; set; } = false;

    /// <summary>
    /// Gets or sets additional CSS classes.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Gets or sets a custom renderer for objects.
    /// </summary>
    [Parameter]
    public RenderFragment<object>? ObjectRenderer { get; set; }

    /// <summary>
    /// Gets or sets additional content to render.
    /// </summary>
    [Parameter]
    public RenderFragment<Activity>? AdditionalContent { get; set; }

    private string GetActorId()
    {
        var actor = Activity?.Actor?.FirstOrDefault();
        if (actor == null) return string.Empty;
        
        // If it's an IObject with an Id
        if (actor is IObject actorObj && !string.IsNullOrEmpty(actorObj.Id))
            return actorObj.Id;
        
        // If it's a Link with Href
        if (actor is Link link && link.Href != null)
            return link.Href.ToString();
        
        return string.Empty;
    }

    private string GetActorName()
    {
        var actor = Activity?.Actor?.FirstOrDefault();
        if (actor == null) return string.Empty;
        
        // Try to get Name property if it's an Actor/Person
        if (actor is Actor actorObj && actorObj.Name?.Any() == true)
            return actorObj.Name.First();
        
        // Try to get Name from any Object
        if (actor is KristofferStrube.ActivityStreams.Object obj && obj.Name?.Any() == true)
            return obj.Name.First();
        
        // Fallback to ID
        return GetActorId();
    }

    private string GetActorImageUrl()
    {
        var actor = Activity?.Actor?.FirstOrDefault();
        if (actor == null) return string.Empty;
        
        if (actor is Person person && person.Icon?.Any() == true)
        {
            var icon = person.Icon.First();
            if (icon is Image img && img.Url?.Any() == true)
            {
                var url = img.Url.First();
                if (url is Link link && link.Href != null)
                    return link.Href.ToString();
            }
        }
        
        return string.Empty;
    }

    private string GetActorUsername()
    {
        var actor = Activity?.Actor?.FirstOrDefault();
        if (actor == null) return string.Empty;
        
        if (actor is Person person && !string.IsNullOrEmpty(person.PreferredUsername))
            return person.PreferredUsername;
        
        return string.Empty;
    }

    private string GetActivityType()
    {
        return Activity?.Type?.FirstOrDefault() ?? "Activity";
    }

    private string GetActivityTypeIcon()
    {
        var type = GetActivityType();
        return type switch
        {
            "Create" => "âœ¨",
            "Update" => "âœï¸",
            "Delete" => "ðŸ—‘ï¸",
            "Follow" => "ðŸ‘¤",
            "Like" => "â¤ï¸",
            "Announce" => "ðŸ”",
            "Accept" => "âœ…",
            "Reject" => "âŒ",
            _ => "ðŸ“„"
        };
    }

    private bool HasRecipients()
    {
        return Activity?.To?.Any() == true || 
               Activity?.Cc?.Any() == true || 
               Activity?.Bcc?.Any() == true;
    }

    private RenderFragment RenderRecipients()
    {
        return builder =>
        {
            var sequence = 0;
            
            if (Activity?.To?.Any() == true)
            {
                foreach (var recipient in Activity.To)
                {
                    var recipientDisplay = GetRecipientDisplay(recipient);
                    if (!string.IsNullOrEmpty(recipientDisplay))
                    {
                        builder.OpenComponent<FluentBadge>(sequence++);
                        builder.AddAttribute(sequence++, "Appearance", Appearance.Lightweight);
                        builder.AddAttribute(sequence++, "ChildContent", (RenderFragment)(b =>
                        {
                            b.AddContent(0, recipientDisplay);
                        }));
                        builder.CloseComponent();
                    }
                }
            }

            if (Activity?.Cc?.Any() == true)
            {
                foreach (var recipient in Activity.Cc)
                {
                    var recipientDisplay = GetRecipientDisplay(recipient);
                    if (!string.IsNullOrEmpty(recipientDisplay))
                    {
                        builder.OpenComponent<FluentBadge>(sequence++);
                        builder.AddAttribute(sequence++, "Appearance", Appearance.Lightweight);
                        builder.AddAttribute(sequence++, "ChildContent", (RenderFragment)(b =>
                        {
                            b.AddContent(0, $"CC: {recipientDisplay}");
                        }));
                        builder.CloseComponent();
                    }
                }
            }
        };
    }
    
    private string GetRecipientDisplay(IObjectOrLink? recipient)
    {
        if (recipient == null) return string.Empty;
        
        // Check for public addressing
        if (recipient is Link link)
        {
            var href = link.Href?.ToString() ?? string.Empty;
            if (href.Contains("#Public") || href.EndsWith("/followers"))
                return href.Contains("#Public") ? "Public" : "Followers";
            return href;
        }
        
        // If it's an Object, try to get Name or Id
        if (recipient is KristofferStrube.ActivityStreams.Object obj)
        {
            if (obj.Name?.Any() == true)
                return obj.Name.First();
            if (!string.IsNullOrEmpty(obj.Id))
                return obj.Id;
        }
        
        return string.Empty;
    }

    private string FormatRecipient(string recipient)
    {
        if (recipient.Contains("public", StringComparison.OrdinalIgnoreCase))
            return "Public";
        if (recipient.Contains("followers", StringComparison.OrdinalIgnoreCase))
            return "Followers";
        
        var uri = new Uri(recipient, UriKind.RelativeOrAbsolute);
        if (uri.IsAbsoluteUri)
            return uri.Host;
        
        return recipient;
    }

    private string FormatDateTime(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime.ToUniversalTime();
        
        if (timeSpan.TotalMinutes < 1)
            return "just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";
        
        return dateTime.ToString("MMM d, yyyy");
    }
}
