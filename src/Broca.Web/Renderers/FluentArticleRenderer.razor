@using KristofferStrube.ActivityStreams
@using Microsoft.FluentUI.AspNetCore.Components
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@inherits ComponentBase

<article class="@($"fluent-article {CssClass}")">
    @if (Article != null)
    {
        <FluentCard>
            @if (ShowFeaturedImage && !string.IsNullOrEmpty(GetFeaturedImageUrl()))
            {
                <div class="article-featured-image">
                    <img src="@GetFeaturedImageUrl()" 
                         alt="@(Article.Name?.FirstOrDefault() ?? "Article image")" 
                         loading="lazy"
                         style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 4px;" />
                </div>
            }

            <div class="article-header">
                @if (Article.Name?.Any() == true)
                {
                    <FluentLabel Typo="Typography.PageTitle" Weight="FontWeight.Bold" class="article-title">
                        @Article.Name.First()
                    </FluentLabel>
                }

                <FluentStack Orientation="Orientation.Horizontal" class="article-meta">
                    @if (ShowAuthor && Article.AttributedTo?.Any() == true)
                    {
                        <FluentLabel Typo="Typography.Body">
                            <FluentIcon Value="@(new Icons.Regular.Size16.Person())" Color="Color.Accent" />
                            <strong>@GetAuthorDisplay()</strong>
                        </FluentLabel>
                    }

                    @if (Article.Published.HasValue)
                    {
                        <FluentLabel Typo="Typography.Body" Color="Color.Neutral">
                            <FluentIcon Value="@(new Icons.Regular.Size16.Calendar())" />
                            <time datetime="@Article.Published.Value.ToString("o")">
                                @Article.Published.Value.ToString("MMMM d, yyyy")
                            </time>
                        </FluentLabel>
                    }

                    @if (ShowReadTime && !string.IsNullOrEmpty(GetContent()))
                    {
                        <FluentLabel Typo="Typography.Body" Color="Color.Neutral">
                            <FluentIcon Value="@(new Icons.Regular.Size16.Clock())" />
                            @CalculateReadTime() min read
                        </FluentLabel>
                    }
                </FluentStack>
            </div>

            @if (Article.Summary?.Any() == true && ShowSummary)
            {
                <FluentCard Class="article-summary" Style="background: var(--neutral-layer-2);">
                    <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">
                        @((MarkupString)(Article.Summary.First() ?? string.Empty))
                    </FluentLabel>
                </FluentCard>
            }

            <FluentDivider />

            @if (!string.IsNullOrEmpty(GetContent()))
            {
                <div class="article-content">
                    @((MarkupString)GetContent())
                </div>
            }

            @if (Article.Tag?.Any() == true && ShowTags)
            {
                <FluentDivider />
                <FluentStack Orientation="Orientation.Horizontal" Wrap="true" class="article-tags">
                    @foreach (var tag in Article.Tag)
                    {
                        <FluentBadge Appearance="Appearance.Lightweight" BackgroundColor="var(--accent-fill-rest)">
                            <FluentIcon Value="@(new Icons.Regular.Size16.Tag())" Slot="start" />
                            @tag.ToString()
                        </FluentBadge>
                    }
                </FluentStack>
            }

            @if (AdditionalContent != null)
            {
                <FluentDivider />
                @AdditionalContent(Article)
            }
        </FluentCard>
    }
</article>

@code {
    /// <summary>
    /// Gets or sets the Article object to render.
    /// </summary>
    [Parameter]
    public Article? Article { get; set; }

    /// <summary>
    /// Gets or sets whether to show the author.
    /// </summary>
    [Parameter]
    public bool ShowAuthor { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to show the summary.
    /// </summary>
    [Parameter]
    public bool ShowSummary { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to show the featured image.
    /// </summary>
    [Parameter]
    public bool ShowFeaturedImage { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to show tags.
    /// </summary>
    [Parameter]
    public bool ShowTags { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to show estimated read time.
    /// </summary>
    [Parameter]
    public bool ShowReadTime { get; set; } = true;

    /// <summary>
    /// Gets or sets additional CSS classes.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Gets or sets additional content to render.
    /// </summary>
    [Parameter]
    public RenderFragment<Article>? AdditionalContent { get; set; }

    private string GetAuthorDisplay()
    {
        var authorId = Article?.AttributedTo?.FirstOrDefault();
        if (authorId is Actor actor && actor.Name?.Any() == true)
            return actor.Name.First();
        return authorId?.ToString() ?? "Unknown Author";
    }

    private string GetContent()
    {
        return Article?.Content?.FirstOrDefault() ?? string.Empty;
    }

    private string GetFeaturedImageUrl()
    {
        if (Article?.Image?.Any() == true)
        {
            var image = Article.Image.First();
            if (image is Image img && img.Url?.Any() == true)
            {
                var urlLink = img.Url.FirstOrDefault();
                if (urlLink?.Href != null)
                {
                    return urlLink.Href.ToString();
                }
            }
            else if (image is Link link && link.Href != null)
            {
                return link.Href.ToString();
            }
        }
        return string.Empty;
    }

    private int CalculateReadTime()
    {
        var content = GetContent();
        if (string.IsNullOrEmpty(content))
            return 0;

        // Strip HTML and count words
        var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", string.Empty);
        var words = plainText.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;
        
        // Average reading speed is ~200 words per minute
        return Math.Max(1, (int)Math.Ceiling(words / 200.0));
    }
}
