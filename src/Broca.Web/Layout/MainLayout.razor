@inherits LayoutComponentBase
@using Broca.ActivityPub.Components
@using Broca.Web.Services
@inject AuthenticationStateService AuthState

<ActivityPubClientProvider>
    <FluentLayout>
        <FluentHeader>
            <div class="header-content">
                <span class="header-title">Broca.Web</span>
                @if (AuthState.IsAuthenticated && AuthState.CurrentActor != null)
                {
                    <div class="header-user">
                        <FluentIcon Value="@(new Icons.Regular.Size20.PersonCircle())" Color="Color.Accent" />
                        <span class="header-user-text">@GetUsername()</span>
                    </div>
                }
            </div>
        </FluentHeader>
        <FluentStack Class="main" Orientation="Orientation.Horizontal" Width="100%">
            <NavMenu />
            <FluentBodyContent Class="body-content">
                <ErrorBoundary>
                    <ChildContent>
                        <div class="content">
                            @Body
                        </div>
                    </ChildContent>
                    <ErrorContent Context="ex">
                        <div class="blazor-error-boundary">@ex.Message</div>
                    </ErrorContent>
                </ErrorBoundary>
            </FluentBodyContent>
        </FluentStack>
        <FluentFooter>
            <a href="https://www.fluentui-blazor.net" target="_blank">Documentation and demos</a>
            <FluentSpacer />
            <a href="https://learn.microsoft.com/en-us/aspnet/core/blazor" target="_blank">About Blazor</a>
        </FluentFooter>
    </FluentLayout>
    
    @if (AuthState.IsAuthenticated)
    {
        <AddContentButton 
            ButtonTemplate="FluentAddContentButtonRenderer.Template"
            Placeholder="What would you like to share?"
            ButtonTitle="Create new post"
            OnPostCreated="@HandlePostCreated">
        </AddContentButton>
    }
</ActivityPubClientProvider>

@code {
    protected override void OnInitialized()
    {
        AuthState.AuthenticationStateChanged += OnAuthStateChanged;
    }

    private void OnAuthStateChanged(object? sender, bool isAuthenticated)
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetDisplayName()
    {
        if (AuthState.CurrentActor?.Name?.FirstOrDefault() is string name && !string.IsNullOrWhiteSpace(name))
            return name;
        
        return GetUsername();
    }

    private string GetUsername()
    {
        if (AuthState.CurrentActor != null && !string.IsNullOrWhiteSpace(AuthState.CurrentActor.PreferredUsername))
            return $"@{AuthState.CurrentActor.PreferredUsername}";
        
        return "User";
    }

    private void HandlePostCreated()
    {
        // Post created successfully - the page will refresh if needed
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthState.AuthenticationStateChanged -= OnAuthStateChanged;
    }
}

<style>
    .header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 0 1rem;
    }

    .header-title {
        font-size: 1.125rem;
        font-weight: 600;
    }

    .header-user {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .header-user-text {
        font-size: 0.875rem;
    }
</style>
