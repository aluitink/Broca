@using KristofferStrube.ActivityStreams
@using Microsoft.JSInterop
@using System.Text.Json
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="object-menu">
    <button class="menu-button" @onclick="ToggleMenu" aria-label="Object menu" title="More options">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <circle cx="10" cy="4" r="2"/>
            <circle cx="10" cy="10" r="2"/>
            <circle cx="10" cy="16" r="2"/>
        </svg>
    </button>
    
    @if (isMenuOpen)
    {
        <div class="menu-dropdown" @onclick:stopPropagation="true">
            <div class="menu-items">
                @if (!string.IsNullOrEmpty(ActorId))
                {
                    <button class="menu-item" @onclick="OpenProfile">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                        </svg>
                        <span>Open Profile</span>
                    </button>
                }
                
                @if (!string.IsNullOrEmpty(ObjectId))
                {
                    <button class="menu-item" @onclick="OpenItem">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M0 1.5A1.5 1.5 0 0 1 1.5 0h8.75a.5.5 0 0 1 .354.146l4.25 4.25a.5.5 0 0 1 .146.354V13.5a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 0 13.5v-12zM1.5 1a.5.5 0 0 0-.5.5v12a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5V5H10.5A1.5 1.5 0 0 1 9 3.5V1H1.5zM10 1v2.5a.5.5 0 0 0 .5.5H13L10 1z"/>
                        </svg>
                        <span>Open Item</span>
                    </button>
                }
                
                @if (Object != null)
                {
                    <button class="menu-item" @onclick="ViewRaw">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M5.854 4.854a.5.5 0 1 0-.708-.708l-3.5 3.5a.5.5 0 0 0 0 .708l3.5 3.5a.5.5 0 0 0 .708-.708L2.707 8l3.147-3.146zm4.292 0a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708-.708L13.293 8l-3.147-3.146z"/>
                        </svg>
                        <span>View Raw</span>
                    </button>
                }
                
                @if (CustomMenuItems != null)
                {
                    @CustomMenuItems
                }
            </div>
        </div>
    }
</div>

@code {
    private bool isMenuOpen = false;

    /// <summary>
    /// Gets or sets the ActivityPub object.
    /// </summary>
    [Parameter]
    public object? Object { get; set; }
    
    /// <summary>
    /// Gets or sets the object ID (e.g., Note ID, Activity ID).
    /// </summary>
    [Parameter]
    public string? ObjectId { get; set; }
    
    /// <summary>
    /// Gets or sets the actor ID for profile navigation.
    /// </summary>
    [Parameter]
    public string? ActorId { get; set; }
    
    /// <summary>
    /// Gets or sets custom menu items.
    /// </summary>
    [Parameter]
    public RenderFragment? CustomMenuItems { get; set; }
    
    /// <summary>
    /// Event callback when menu item is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<string> OnMenuItemClicked { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && isMenuOpen)
        {
            await JS.InvokeVoidAsync("eval", @"
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.object-menu')) {
                        window.closeAllMenus && window.closeAllMenus();
                    }
                });
            ");
        }
    }

    private void ToggleMenu()
    {
        isMenuOpen = !isMenuOpen;
    }

    private async Task OpenProfile()
    {
        if (!string.IsNullOrEmpty(ActorId))
        {
            Navigation.NavigateTo($"/actor?id={Uri.EscapeDataString(ActorId)}");
            await OnMenuItemClicked.InvokeAsync("profile");
            isMenuOpen = false;
        }
    }

    private async Task OpenItem()
    {
        if (!string.IsNullOrEmpty(ObjectId))
        {
            Navigation.NavigateTo($"/object?id={Uri.EscapeDataString(ObjectId)}");
            await OnMenuItemClicked.InvokeAsync("item");
            isMenuOpen = false;
        }
    }

    private async Task ViewRaw()
    {
        if (Object != null)
        {
            try
            {
                var options = new JsonSerializerOptions 
                { 
                    WriteIndented = true,
                    DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull
                };
                var json = JsonSerializer.Serialize(Object, options);
                
                // Open a modal or new window with the JSON
                await JS.InvokeVoidAsync("alert", json);
                
                await OnMenuItemClicked.InvokeAsync("raw");
                isMenuOpen = false;
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Error serializing object: {ex.Message}");
            }
        }
    }
}
