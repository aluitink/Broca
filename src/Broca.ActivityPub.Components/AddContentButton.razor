@using Broca.ActivityPub.Core.Interfaces
@using KristofferStrube.ActivityStreams

<div class="activitypub-add-content-wrapper @CssClass">
    @if (ButtonTemplate != null)
    {
        @ButtonTemplate(this)
    }
    else
    {
        @if (!HideButton)
        {
            <button class="add-content-fab" 
                    @onclick="OpenAsync" 
                    title="@ButtonTitle"
                    style="@GetButtonStyle()">
                <span class="fab-icon">@ButtonIcon</span>
            </button>
        }
    }
</div>

@code {
    /// <summary>
    /// Gets or sets the custom button template for rendering the add content button.
    /// </summary>
    [Parameter]
    public RenderFragment<AddContentButton>? ButtonTemplate { get; set; }

    /// <summary>
    /// Gets or sets the button icon.
    /// </summary>
    [Parameter]
    public string ButtonIcon { get; set; } = "✏️";

    /// <summary>
    /// Gets or sets the button title (tooltip).
    /// </summary>
    [Parameter]
    public string ButtonTitle { get; set; } = "Create new post";

    /// <summary>
    /// Gets or sets the placeholder text for the composer.
    /// </summary>
    [Parameter]
    public string Placeholder { get; set; } = "What's on your mind?";

    /// <summary>
    /// Gets or sets the maximum content length.
    /// </summary>
    [Parameter]
    public int MaxLength { get; set; } = 500;

    /// <summary>
    /// Gets or sets the number of rows for the dialog textarea.
    /// </summary>
    [Parameter]
    public int DialogRows { get; set; } = 8;

    /// <summary>
    /// Gets or sets whether to hide the floating button.
    /// </summary>
    [Parameter]
    public bool HideButton { get; set; } = false;

    /// <summary>
    /// Gets or sets whether to show the dialog on initialization.
    /// </summary>
    [Parameter]
    public bool ShowDialogOnInit { get; set; } = false;

    /// <summary>
    /// Gets or sets the position from the bottom (in pixels).
    /// </summary>
    [Parameter]
    public int BottomPosition { get; set; } = 24;

    /// <summary>
    /// Gets or sets the position from the right (in pixels).
    /// </summary>
    [Parameter]
    public int RightPosition { get; set; } = 24;

    /// <summary>
    /// Gets or sets additional CSS classes.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Gets or sets the accepted file types for attachments.
    /// </summary>
    [Parameter]
    public string AcceptedFileTypes { get; set; } = "image/*,video/*";

    /// <summary>
    /// Gets or sets a callback for when a post is successfully created.
    /// </summary>
    [Parameter]
    public EventCallback<Activity> OnPostCreated { get; set; }

    /// <summary>
    /// Gets or sets the ID of the activity this is in reply to (if any).
    /// </summary>
    [Parameter]
    public string? InReplyToId { get; set; }

    /// <summary>
    /// Gets or sets the dialog title.
    /// </summary>
    [Parameter]
    public string DialogTitle { get; set; } = "Create Post";

    /// <summary>
    /// Event triggered when the button is clicked.  Renderer should handle opening dialog.
    /// </summary>
    [Parameter]
    public EventCallback OnButtonClick { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (ShowDialogOnInit && OnButtonClick.HasDelegate)
        {
            await OnButtonClick.InvokeAsync();
        }
    }

    public async Task OpenAsync()
    {
        if (OnButtonClick.HasDelegate)
        {
            await OnButtonClick.InvokeAsync();
        }
    }

    private string GetButtonStyle()
    {
        return $"bottom: {BottomPosition}px; right: {RightPosition}px;";
    }

    /// <summary>
    /// Opens the dialog programmatically.
    /// </summary>
    public async Task Open()
    {
        await OpenAsync();
    }
}
