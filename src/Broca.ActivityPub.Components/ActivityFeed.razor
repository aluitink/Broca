@using KristofferStrube.ActivityStreams
@using Broca.ActivityPub.Core.Interfaces
@using Broca.ActivityPub.Components.Services
@inject IActivityPubClient Client
@inject ActivityStreamNotificationService? NotificationService
@implements IDisposable

<div class="activitypub-activity-feed @CssClass">
    @if (!string.IsNullOrEmpty(Title))
    {
        <div class="feed-header">
            <h3>@Title</h3>
            @if (EnableAutoRefresh && isAutoRefreshActive)
            {
                <span class="refresh-indicator" title="Auto-refreshing every @AutoRefreshInterval seconds">ðŸ”„</span>
            }
        </div>
    }

    @if (newActivitiesCount > 0 && ShowNewPostsNotification)
    {
        <div class="new-posts-notification">
            <button @onclick="LoadNewActivitiesAsync" class="load-new-button">
                @newActivitiesCount new @(newActivitiesCount == 1 ? "post" : "posts") available
            </button>
        </div>
    }

    @if (CollectionUrl != null)
    {
        <CollectionLoader @ref="collectionLoaderRef"
                         TItem="Activity" 
                         CollectionUrl="@CollectionUrl" 
                         PageSize="@PageSize"
                         UseVirtualization="@UseVirtualization"
                         ItemSize="@ItemSize"
                         OverscanCount="@OverscanCount"
                         OnItemsLoaded="@HandleItemsLoaded">
            <ItemTemplate Context="activity">
                @if (ActivityTemplate != null)
                {
                    @ActivityTemplate(activity)
                }
                else
                {
                    <ActivityRenderer Activity="@activity" />
                }
            </ItemTemplate>
            <LoadingTemplate>
                @if (LoadingTemplate != null)
                {
                    @LoadingTemplate
                }
                else
                {
                    <div class="feed-loading">
                        <span class="loading-spinner"></span>
                        <span>Loading activities...</span>
                    </div>
                }
            </LoadingTemplate>
            <EmptyTemplate>
                @if (EmptyTemplate != null)
                {
                    @EmptyTemplate
                }
                else
                {
                    <div class="feed-empty">
                        <p>No activities found</p>
                    </div>
                }
            </EmptyTemplate>
            <ErrorTemplate Context="error">
                @if (ErrorTemplate != null)
                {
                    @ErrorTemplate(error)
                }
                else
                {
                    <div class="feed-error">
                        <p>Error loading activities: @error</p>
                    </div>
                }
            </ErrorTemplate>
        </CollectionLoader>
    }
    else
    {
        <div class="feed-error">
            <p>No collection URL specified</p>
        </div>
    }
</div>

@code {
    private System.Threading.Timer? refreshTimer;
    private int newActivitiesCount = 0;
    private bool isAutoRefreshActive = false;
    private string? latestActivityId = null;
    private CollectionLoader<Activity>? collectionLoaderRef;
    private IDisposable? notificationSubscription;

    /// <summary>
    /// Gets or sets the URL of the activity collection (e.g., outbox, inbox).
    /// </summary>
    [Parameter]
    public Uri? CollectionUrl { get; set; }

    /// <summary>
    /// Gets or sets the title of the feed.
    /// </summary>
    [Parameter]
    public string? Title { get; set; }

    /// <summary>
    /// Gets or sets the page size for loading activities.
    /// </summary>
    [Parameter]
    public int PageSize { get; set; } = 20;

    /// <summary>
    /// Gets or sets whether to use virtualization.
    /// </summary>
    [Parameter]
    public bool UseVirtualization { get; set; } = true;

    /// <summary>
    /// Gets or sets the item size for virtualization (in pixels).
    /// </summary>
    [Parameter]
    public float ItemSize { get; set; } = 150f;

    /// <summary>
    /// Gets or sets the overscan count for virtualization.
    /// </summary>
    [Parameter]
    public int OverscanCount { get; set; } = 3;

    /// <summary>
    /// Gets or sets whether to enable auto-refresh.
    /// </summary>
    [Parameter]
    public bool EnableAutoRefresh { get; set; } = true;

    /// <summary>
    /// Gets or sets the auto-refresh interval in seconds.
    /// </summary>
    [Parameter]
    public int AutoRefreshInterval { get; set; } = 30;

    /// <summary>
    /// Gets or sets whether to show new posts notification.
    /// </summary>
    [Parameter]
    public bool ShowNewPostsNotification { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to auto-scroll to new posts.
    /// </summary>
    [Parameter]
    public bool AutoScrollToNew { get; set; } = false;

    /// <summary>
    /// Gets or sets additional CSS classes.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Gets or sets a callback for when new activities are detected.
    /// </summary>
    [Parameter]
    public EventCallback<int> OnNewActivitiesDetected { get; set; }

    protected override void OnInitialized()
    {
        if (EnableAutoRefresh)
        {
            StartAutoRefresh();
        }

        // Subscribe to activity notifications
        if (NotificationService != null)
        {
            notificationSubscription = NotificationService.Subscribe(OnActivityPostedAsync);
        }
    }

    private async Task OnActivityPostedAsync(Activity activity)
    {
        // When a new activity is posted, immediately refresh the feed
        // This ensures the user sees their new post without manual refresh
        await InvokeAsync(async () =>
        {
            await RefreshAsync();
        });
    }

    protected override void OnParametersSet()
    {
        if (EnableAutoRefresh && !isAutoRefreshActive)
        {
            StartAutoRefresh();
        }
        else if (!EnableAutoRefresh && isAutoRefreshActive)
        {
            StopAutoRefresh();
        }
    }

    private void StartAutoRefresh()
    {
        if (isAutoRefreshActive) return;

        isAutoRefreshActive = true;
        refreshTimer = new System.Threading.Timer(
            async _ => await CheckForNewActivitiesAsync(),
            null,
            TimeSpan.FromSeconds(AutoRefreshInterval),
            TimeSpan.FromSeconds(AutoRefreshInterval)
        );
    }

    private void StopAutoRefresh()
    {
        isAutoRefreshActive = false;
        refreshTimer?.Dispose();
        refreshTimer = null;
    }

    private async Task CheckForNewActivitiesAsync()
    {
        try
        {
            if (CollectionUrl == null) return;

            // Get the first page to check for new activities
            var loadedItems = new List<Activity>();
            await foreach (var item in Client.GetCollectionAsync<Activity>(CollectionUrl, 5))
            {
                loadedItems.Add(item);
                if (loadedItems.Count >= 5)
                {
                    break;
                }
            }

            if (loadedItems.Any())
            {
                var newestId = loadedItems.First().Id;
                
                // If we have a latest activity ID and it's different, we have new activities
                if (!string.IsNullOrEmpty(latestActivityId) && newestId != latestActivityId)
                {
                    // Count how many new activities there are
                    var countNew = 0;
                    foreach (var activity in loadedItems)
                    {
                        if (activity.Id == latestActivityId)
                        {
                            break;
                        }
                        countNew++;
                    }
                    
                    newActivitiesCount = countNew;
                    
                    await InvokeAsync(StateHasChanged);
                    
                    if (OnNewActivitiesDetected.HasDelegate)
                    {
                        await OnNewActivitiesDetected.InvokeAsync(newActivitiesCount);
                    }

                    if (AutoScrollToNew)
                    {
                        await LoadNewActivitiesAsync();
                    }
                }
            }
        }
        catch
        {
            // Silently fail - don't interrupt the feed
        }
    }

    private async Task LoadNewActivitiesAsync()
    {
        newActivitiesCount = 0;
        
        if (collectionLoaderRef != null)
        {
            await collectionLoaderRef.RefreshAsync();
        }
        
        StateHasChanged();
    }

    private Task HandleItemsLoaded(IEnumerable<Activity> activities)
    {
        // Track the latest activity ID for new activity detection
        var firstActivity = activities.FirstOrDefault();
        if (firstActivity != null && !string.IsNullOrEmpty(firstActivity.Id))
        {
            latestActivityId = firstActivity.Id;
        }
        
        return Task.CompletedTask;
    }

    /// <summary>
    /// Manually refreshes the feed.
    /// </summary>
    public async Task RefreshAsync()
    {
        newActivitiesCount = 0;
        
        if (collectionLoaderRef != null)
        {
            await collectionLoaderRef.RefreshAsync();
        }
        
        StateHasChanged();
    }

    /// <summary>
    /// Starts auto-refresh if not already running.
    /// </summary>
    public void EnableRefresh()
    {
        if (!isAutoRefreshActive)
        {
            StartAutoRefresh();
        }
    }

    /// <summary>
    /// Stops auto-refresh.
    /// </summary>
    public void DisableRefresh()
    {
        if (isAutoRefreshActive)
        {
            StopAutoRefresh();
        }
    }

    public void Dispose()
    {
        StopAutoRefresh();
        notificationSubscription?.Dispose();
    }    /// <summary>
    /// Gets or sets a custom activity rendering template.
    /// </summary>
    [Parameter]
    public RenderFragment<Activity>? ActivityTemplate { get; set; }

    /// <summary>
    /// Gets or sets the loading template.
    /// </summary>
    [Parameter]
    public RenderFragment? LoadingTemplate { get; set; }

    /// <summary>
    /// Gets or sets the empty state template.
    /// </summary>
    [Parameter]
    public RenderFragment? EmptyTemplate { get; set; }

    /// <summary>
    /// Gets or sets the error template.
    /// </summary>
    [Parameter]
    public RenderFragment<string>? ErrorTemplate { get; set; }
}

