@inject IActivityPubClient Client

<div class="activitypub-actor-profile @CssClass">
    @if (isLoading)
    {
        @if (LoadingTemplate != null)
        {
            @LoadingTemplate
        }
        else
        {
            <div class="profile-loading">Loading profile...</div>
        }
    }
    else if (error != null)
    {
        @if (ErrorTemplate != null)
        {
            @ErrorTemplate(error)
        }
        else
        {
            <div class="profile-error">@error</div>
        }
    }
    else if (actor != null)
    {
        @if (ProfileTemplate != null)
        {
            @ProfileTemplate(actor)
        }
        else
        {
            <div class="profile-content">
                <ActorRenderer Actor="@actor" ShowDetails="@ShowDetails" />
                
                @if (ShowFollowButton && CanShowFollowButton())
                {
                    <div class="profile-actions">
                        @if (isFollowing)
                        {
                            <button class="follow-button following" 
                                    @onclick="HandleUnfollowClick"
                                    disabled="@isFollowProcessing">
                                @if (isFollowProcessing)
                                {
                                    <span>Processing...</span>
                                }
                                else
                                {
                                    <span>âœ“ Following</span>
                                }
                            </button>
                        }
                        else
                        {
                            <button class="follow-button" 
                                    @onclick="HandleFollowClick"
                                    disabled="@isFollowProcessing">
                                @if (isFollowProcessing)
                                {
                                    <span>Processing...</span>
                                }
                                else
                                {
                                    <span>+ Follow</span>
                                }
                            </button>
                        }
                    </div>
                }

                @if (ShowStatistics)
                {
                    <div class="profile-statistics">
                        @if (followersCount.HasValue)
                        {
                            <div class="stat-item">
                                <span class="stat-label">Followers</span>
                                <span class="stat-value">@FormatCount(followersCount.Value)</span>
                            </div>
                        }
                        @if (followingCount.HasValue)
                        {
                            <div class="stat-item">
                                <span class="stat-label">Following</span>
                                <span class="stat-value">@FormatCount(followingCount.Value)</span>
                            </div>
                        }
                        @if (postsCount.HasValue)
                        {
                            <div class="stat-item">
                                <span class="stat-label">Posts</span>
                                <span class="stat-value">@FormatCount(postsCount.Value)</span>
                            </div>
                        }
                    </div>
                }
            </div>
        }

        @if (ShowOutbox && !string.IsNullOrEmpty(GetOutboxUrl()))
        {
            <div class="profile-outbox">
                <h4>Recent Activities</h4>
                <ActivityFeed CollectionUrl="@(new Uri(GetOutboxUrl()))" 
                             PageSize="@OutboxPageSize"
                             UseVirtualization="@false" />
            </div>
        }
    }
</div>

@code {
    private KristofferStrube.ActivityStreams.Object? actor;
    private bool isLoading;
    private bool isFollowing;
    private bool isFollowProcessing;
    private int? followersCount;
    private int? followingCount = null;
    private int? postsCount = null;
    private string? error;

    /// <summary>
    /// Gets or sets the actor URI to display.
    /// </summary>
    [Parameter]
    public Uri? ActorUri { get; set; }

    /// <summary>
    /// Gets or sets the actor handle/alias (e.g., user@domain.com).
    /// </summary>
    [Parameter]
    public string? ActorHandle { get; set; }

    /// <summary>
    /// Gets or sets the actor object directly.
    /// </summary>
    [Parameter]
    public KristofferStrube.ActivityStreams.Object? Actor { get; set; }

    /// <summary>
    /// Gets or sets whether to show detailed information.
    /// </summary>follow button.
    /// </summary>
    [Parameter]
    public bool ShowFollowButton { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to show statistics.
    /// </summary>
    [Parameter]
    public bool ShowStatistics { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to show the 
    [Parameter]
    public bool ShowDetails { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to show the actor's outbox.
    /// </summary>
    [Parameter]
    public bool ShowOutbox { get; set; } = false;

    /// <summary>
    /// Gets or sets the page size for the outbox feed.
    /// </summary>
    [Parameter]
    public int OutboxPageSize { get; set; } = 10;

    /// <summary>
    /// Gets or sets additional CSS classes.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// <summary>
    /// Gets or sets a callback for when follow state changes.
    /// </summary>
    [Parameter]
    public EventCallback<bool> OnFollowStateChanged { get; set; }

    /// Gets or sets a custom profile rendering template.
    /// </summary>
    [Parameter]
    public RenderFragment<KristofferStrube.ActivityStreams.Object>? ProfileTemplate { get; set; }

    /// <summary>
    /// Gets or sets the loading template.
    /// </summary>
    [Parameter]
    public RenderFragment? LoadingTemplate { get; set; }

    /// <summary>
    /// Gets or sets the error template.
    /// </summary>
    [Parameter]
    public RenderFragment<string>? ErrorTemplate { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (Actor != null)
        {
            actor = Actor;
            return;
        }

        if (ActorUri != null || !string.IsNullOrEmpty(ActorHandle))
        {
            await LoadActorAsync();
        }
    }

    private async Task LoadActorAsync()
    {
        isLoading = true;

        // Load statistics if available
        if (actor != null)
        {
            await LoadStatisticsAsync();
        }
    }

    private Task LoadStatisticsAsync()
    {
        try
        {
            // TODO: Load actual statistics from collections
            // For now, these would need to be fetched from the followers/following/outbox collections
            // followersCount = await GetCollectionCount(GetFollowersUrl());
            // followingCount = await GetCollectionCount(GetFollowingUrl());
            // postsCount = await GetCollectionCount(GetOutboxUrl());
        }
        catch
        {
            // Silently fail - statistics are optional
        }

        return Task.CompletedTask;
    }

    private bool CanShowFollowButton()
    {
        // Don't show follow button if viewing own profile or not authenticated
        return Client.ActorId != null && actor?.Id != Client.ActorId;
    }

    private async Task HandleFollowClick()
    {
        if (actor?.Id == null || !CanShowFollowButton()) return;

        isFollowProcessing = true;
        StateHasChanged();

        try
        {
            var followActivity = Client.CreateActivityBuilder().Follow(actor.Id);
            await Client.PostToOutboxAsync(followActivity);
            
            isFollowing = true;
            
            if (followersCount.HasValue)
            {
                followersCount++;
            }

            if (OnFollowStateChanged.HasDelegate)
            {
                await OnFollowStateChanged.InvokeAsync(true);
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to follow: {ex.Message}";
        }
        finally
        {
            isFollowProcessing = false;
            StateHasChanged();
        }
    }

    private async Task HandleUnfollowClick()
    {
        if (actor?.Id == null || !CanShowFollowButton()) return;

        isFollowProcessing = true;
        StateHasChanged();

        try
        {
            // TODO: Need to track original Follow activity to properly Undo it
            var followActivity = Client.CreateActivityBuilder().Follow(actor.Id);
            var undoActivity = Client.CreateActivityBuilder().Undo(followActivity);
            await Client.PostToOutboxAsync(undoActivity);
            
            isFollowing = false;
            
            if (followersCount.HasValue && followersCount.Value > 0)
            {
                followersCount--;
            }

            if (OnFollowStateChanged.HasDelegate)
            {
                await OnFollowStateChanged.InvokeAsync(false);
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to unfollow: {ex.Message}";
        }
        finally
        {
            isFollowProcessing = false;
            StateHasChanged();
        }
    }

    private string GetOutboxUrl()
    {
        if (actor is Person person && person.Outbox != null)
        {
            return person.Outbox.ToString() ?? string.Empty;
        }
        return string.Empty;
    }

    private string FormatCount(int count)
    {
        if (count < 1000)
            return count.ToString();
        if (count < 1000000)
            return $"{count / 1000.0:F1}K";
        return $"{count / 1000000.0:F1}M";
    }
}

