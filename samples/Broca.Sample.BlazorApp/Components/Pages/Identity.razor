@page "/identity"
@using Microsoft.JSInterop
@using System.Text.Json
@inject IdentityService IdentityService
@inject IJSRuntime JSRuntime

<PageTitle>Identity Management</PageTitle>

<div class="container mt-4">
    <h1>Identity Management</h1>

    <div class="row mt-4">
        <div class="col-md-8">
            @if (IdentityService.IsAuthenticated)
            {
                <div class="alert alert-success">
                    <h4 class="alert-heading">Identity Loaded</h4>
                    <p><strong>Username:</strong> @IdentityService.CurrentIdentity?.Username</p>
                    <p><strong>Domain:</strong> @IdentityService.CurrentIdentity?.Domain</p>
                    <p><strong>Actor ID:</strong> @IdentityService.CurrentIdentity?.ActorId</p>
                    <hr>
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" @onclick="DownloadIdentity">
                            <i class="bi bi-download"></i> Download Identity
                        </button>
                        <button class="btn btn-danger" @onclick="ClearIdentity">
                            <i class="bi bi-trash"></i> Clear Identity
                        </button>
                    </div>
                </div>
            }
            else
            {
                <!-- Create New Identity Card -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5>Create New Identity</h5>
                    </div>
                    <div class="card-body">
                        <p>Generate a new ActivityPub identity with cryptographic keys.</p>
                        
                        <div class="mb-3">
                            <label for="newUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="newUsername" @bind="newUsername" placeholder="alice" />
                            <small class="form-text text-muted">Your unique username (letters, numbers, and underscores only)</small>
                        </div>

                        <div class="mb-3">
                            <label for="newDomain" class="form-label">Domain</label>
                            <input type="text" class="form-control" id="newDomain" @bind="newDomain" placeholder="example.com" />
                            <small class="form-text text-muted">The domain where your ActivityPub server is hosted</small>
                        </div>

                        <div class="mb-3">
                            <label for="newActorId" class="form-label">Actor ID (Optional)</label>
                            <input type="text" class="form-control" id="newActorId" @bind="newActorId" placeholder="https://example.com/users/alice" />
                            <small class="form-text text-muted">Leave empty to auto-generate from username and domain</small>
                        </div>

                        <button class="btn btn-primary" @onclick="CreateNewIdentity" disabled="@(!CanCreateIdentity)">
                            <i class="bi bi-key"></i> Generate Identity
                        </button>

                        @if (!string.IsNullOrWhiteSpace(createSuccessMessage))
                        {
                            <div class="alert alert-success mt-3" role="alert">
                                @createSuccessMessage
                            </div>
                        }
                    </div>
                </div>

                <!-- Upload Existing Identity Card -->
                <div class="card">
                    <div class="card-header">
                        <h5>Load Existing Identity</h5>
                    </div>
                    <div class="card-body">
                        <p>Load your ActivityPub identity from a JSON file containing your public and private keys.</p>
                        
                        <div class="mb-3">
                            <label for="identityFile" class="form-label">Select Identity File</label>
                            <InputFile OnChange="HandleFileSelected" class="form-control" id="identityFile" accept=".json" />
                        </div>

                        @if (!string.IsNullOrWhiteSpace(errorMessage))
                        {
                            <div class="alert alert-danger" role="alert">
                                @errorMessage
                            </div>
                        }

                        @if (!string.IsNullOrWhiteSpace(successMessage))
                        {
                            <div class="alert alert-success" role="alert">
                                @successMessage
                            </div>
                        }
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Expected JSON Format</h5>
                    </div>
                    <div class="card-body">
                        <p>Your identity JSON file should have the following structure:</p>
                        <pre><code>@exampleJson</code></pre>
                    </div>
                </div>
            }
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">About Identity</h5>
                    <p class="card-text">
                        Your identity file contains your ActivityPub actor information and cryptographic keys.
                    </p>
                    <p class="card-text">
                        <strong>Important:</strong> Keep your private key secure and never share it.
                    </p>
                    <p class="card-text">
                        The identity is only stored in your browser's memory and will be cleared when you close the tab.
                    </p>
                </div>
            </div>

            @if (IdentityService.IsAuthenticated)
            {
                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="card-title">ðŸ’¾ Backup Your Identity</h5>
                        <p class="card-text">
                            Download your identity file and keep it in a safe place. You'll need it to authenticate from other browsers or devices.
                        </p>
                    </div>
                </div>
            }
            else
            {
                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="card-title">ðŸ”‘ Getting Started</h5>
                        <p class="card-text">
                            <strong>New to ActivityPub?</strong> Click "Generate Identity" to create a new identity with cryptographic keys.
                        </p>
                        <p class="card-text">
                            <strong>Already have an identity?</strong> Upload your identity JSON file to authenticate.
                        </p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string? errorMessage;
    private string? successMessage;
    private string? createSuccessMessage;
    private const long maxFileSize = 1024 * 10; // 10 KB

    private string newUsername = string.Empty;
    private string newDomain = string.Empty;
    private string? newActorId;

    private bool CanCreateIdentity => 
        !string.IsNullOrWhiteSpace(newUsername) && 
        !string.IsNullOrWhiteSpace(newDomain);

    private readonly string exampleJson = @"{
  ""actorId"": ""https://example.com/users/alice"",
  ""username"": ""alice"",
  ""domain"": ""example.com"",
  ""publicKey"": ""-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----"",
  ""privateKey"": ""-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----""
}";

    private async Task CreateNewIdentity()
    {
        try
        {
            errorMessage = null;
            createSuccessMessage = null;

            var identity = await IdentityService.CreateIdentityAsync(
                newUsername.Trim(), 
                newDomain.Trim(), 
                string.IsNullOrWhiteSpace(newActorId) ? null : newActorId.Trim()
            );

            createSuccessMessage = "Identity created successfully! Don't forget to download and save it.";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating identity: {ex.Message}";
        }
    }

    private async Task DownloadIdentity()
    {
        try
        {
            await IdentityService.DownloadIdentityAsync($"{IdentityService.CurrentIdentity?.Username}_identity.json");
            successMessage = "Identity downloaded successfully!";
            StateHasChanged();
            
            // Clear success message after a few seconds
            await Task.Delay(3000);
            successMessage = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error downloading identity: {ex.Message}";
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        errorMessage = null;
        successMessage = null;

        var file = e.File;

        if (file == null)
        {
            return;
        }

        if (file.Size > maxFileSize)
        {
            errorMessage = $"File size exceeds maximum allowed size of {maxFileSize / 1024} KB";
            return;
        }

        try
        {
            using var stream = file.OpenReadStream(maxFileSize);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();

            var success = await IdentityService.LoadIdentityFromFileAsync(content);

            if (success)
            {
                successMessage = "Identity loaded successfully!";
                StateHasChanged();
                
                // Navigate to browse page after a short delay
                await Task.Delay(1500);
                await JSRuntime.InvokeVoidAsync("eval", "window.location.href = '/browse'");
            }
            else
            {
                errorMessage = "Failed to parse identity file. Please check the file format.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading identity: {ex.Message}";
        }
    }

    private void ClearIdentity()
    {
        IdentityService.ClearIdentity();
        successMessage = null;
        errorMessage = null;
        createSuccessMessage = null;
        newUsername = string.Empty;
        newDomain = string.Empty;
        newActorId = null;
    }
}
