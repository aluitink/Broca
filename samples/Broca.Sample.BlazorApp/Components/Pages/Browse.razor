@page "/browse"
@using Broca.ActivityPub.Core.Interfaces
@using KristofferStrube.ActivityStreams
@inject IActivityPubClient ActivityPubClient
@inject IdentityService IdentityService

<PageTitle>Browse ActivityPub</PageTitle>

<div class="container mt-4">
    <h1>ActivityPub Browser</h1>

    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Lookup User</h5>
                    <div class="input-group mb-3">
                        <input type="text" 
                               class="form-control" 
                               placeholder="user@domain.com" 
                               @bind="userAlias"
                               @onkeypress="HandleKeyPress" />
                        <button class="btn btn-primary" 
                                @onclick="LookupUser" 
                                disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            Lookup
                        </button>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            @errorMessage
                        </div>
                    }

                    @if (currentActor != null)
                    {
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5>@(currentActor.Name != null && currentActor.Name.Any() ? currentActor.Name.FirstOrDefault() : currentActor.PreferredUsername)</h5>
                                <small class="text-muted">@@@currentActor.PreferredUsername</small>
                            </div>
                            <div class="card-body">
                                @if (currentActor.Summary != null && currentActor.Summary.Any())
                                {
                                    <p class="card-text">@currentActor.Summary.FirstOrDefault()</p>
                                }
                                <dl class="row">
                                    <dt class="col-sm-3">Type:</dt>
                                    <dd class="col-sm-9">@(currentActor.Type != null ? string.Join(", ", currentActor.Type) : "N/A")</dd>

                                    @if (currentActor.Url != null)
                                    {
                                        <dt class="col-sm-3">URL:</dt>
                                        <dd class="col-sm-9">
                                            @if (currentActor.Url is IEnumerable<KristofferStrube.ActivityStreams.IObjectOrLink> urls)
                                            {
                                                @foreach (var urlObj in urls)
                                                {
                                                    @if (urlObj is KristofferStrube.ActivityStreams.Link urlLink && urlLink.Href != null)
                                                    {
                                                        <a href="@urlLink.Href" target="_blank" class="d-block">@urlLink.Href</a>
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                <span>@currentActor.Url</span>
                                            }
                                        </dd>
                                    }

                                    @if (currentActor.Followers != null)
                                    {
                                        <dt class="col-sm-3">Followers:</dt>
                                        <dd class="col-sm-9">
                                            @if (currentActor.Followers is KristofferStrube.ActivityStreams.Link followersLink && followersLink.Href != null)
                                            {
                                                <a href="@followersLink.Href" target="_blank">@followersLink.Href</a>
                                            }
                                            else
                                            {
                                                @currentActor.Followers.ToString()
                                            }
                                        </dd>
                                    }

                                    @if (currentActor.Following != null)
                                    {
                                        <dt class="col-sm-3">Following:</dt>
                                        <dd class="col-sm-9">
                                            @if (currentActor.Following is KristofferStrube.ActivityStreams.Link followingLink && followingLink.Href != null)
                                            {
                                                <a href="@followingLink.Href" target="_blank">@followingLink.Href</a>
                                            }
                                            else
                                            {
                                                @currentActor.Following.ToString()
                                            }
                                        </dd>
                                    }

                                    @if (currentActor.Outbox != null)
                                    {
                                        <dt class="col-sm-3">Outbox:</dt>
                                        <dd class="col-sm-9">
                                            @if (currentActor.Outbox is KristofferStrube.ActivityStreams.Link outboxLink && outboxLink.Href != null)
                                            {
                                                <a href="@outboxLink.Href" target="_blank" class="d-block mb-2">@outboxLink.Href</a>
                                            }
                                            <button class="btn btn-sm btn-secondary" @onclick="LoadOutbox" disabled="@isLoadingOutbox">
                                                @if (isLoadingOutbox)
                                                {
                                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                                }
                                                Load Outbox
                                            </button>
                                        </dd>
                                    }
                                </dl>
                            </div>
                        </div>

                        @if (outboxActivities.Count > 0)
                        {
                            <div class="card">
                                <div class="card-header">
                                    <h5>Outbox Activities (@outboxActivities.Count)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group">
                                        @foreach (var activity in outboxActivities)
                                        {
                                            <div class="list-group-item">
                                                <div class="d-flex w-100 justify-content-between">
                                                    <h6 class="mb-1">@activity.Type</h6>
                                                    @if (activity.Published.HasValue)
                                                    {
                                                        <small>@activity.Published.Value.ToString("g")</small>
                                                    }
                                                </div>
                                                @if (activity.Summary != null && activity.Summary.Any())
                                                {
                                                    <p class="mb-1">@activity.Summary.FirstOrDefault()</p>
                                                }
                                                @if (activity.Object != null)
                                                {
                                                    <small class="text-muted">Object: @activity.Object</small>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Identity</h5>
                    @if (IdentityService.IsAuthenticated)
                    {
                        <div class="alert alert-success">
                            <strong>Authenticated</strong><br/>
                            <small>@IdentityService.CurrentIdentity?.Username@@@IdentityService.CurrentIdentity?.Domain</small>
                        </div>
                        <button class="btn btn-sm btn-danger" @onclick="ClearIdentity">Clear Identity</button>
                    }
                    else
                    {
                        <p class="text-muted">Browsing anonymously</p>
                        <p class="small">Load your identity from a JSON file to authenticate requests.</p>
                    }
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Recent Lookups</h5>
                    @if (recentLookups.Count > 0)
                    {
                        <div class="list-group">
                            @foreach (var lookup in recentLookups)
                            {
                                <button class="list-group-item list-group-item-action" @onclick="() => QuickLookup(lookup)">
                                    @lookup
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted small">No recent lookups</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string userAlias = "";
    private bool isLoading = false;
    private bool isLoadingOutbox = false;
    private string? errorMessage;
    private Actor? currentActor;
    private List<Activity> outboxActivities = new();
    private List<string> recentLookups = new();

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading)
        {
            await LookupUser();
        }
    }

    private async Task LookupUser()
    {
        if (string.IsNullOrWhiteSpace(userAlias))
        {
            errorMessage = "Please enter a user alias";
            return;
        }

        isLoading = true;
        errorMessage = null;
        currentActor = null;
        outboxActivities.Clear();

        try
        {
            currentActor = await ActivityPubClient.GetActorByAliasAsync(userAlias);
            
            if (!recentLookups.Contains(userAlias))
            {
                recentLookups.Insert(0, userAlias);
                if (recentLookups.Count > 5)
                {
                    recentLookups.RemoveAt(5);
                }
            }
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.BadRequest)
        {
            errorMessage = $"User not found: The account '{userAlias}' does not exist on this server. Error: {ex.Message}";
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            errorMessage = $"User not found: The account '{userAlias}' does not exist.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to lookup user: {ex.Message}";
            
            // Log the full exception for debugging
            if (ex.InnerException != null)
            {
                errorMessage += $"\n\nDetails: {ex.InnerException.Message}";
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadOutbox()
    {
        if (currentActor?.Outbox == null) return;

        isLoadingOutbox = true;
        errorMessage = null;

        try
        {
            // Try to get the outbox URL - it could be a string or an ILink
            string? outboxUrl = null;
            
            try
            {
                // First check if it's a Link object with an Href property
                var linkType = currentActor.Outbox.GetType();
                var hrefProp = linkType.GetProperty("Href");
                if (hrefProp != null)
                {
                    var hrefValue = hrefProp.GetValue(currentActor.Outbox);
                    if (hrefValue is string href)
                    {
                        outboxUrl = href;
                    }
                    else if (hrefValue is Uri uri)
                    {
                        outboxUrl = uri.ToString();
                    }
                }
                
                // If no Href, try treating it as a string
                if (outboxUrl == null)
                {
                    outboxUrl = currentActor.Outbox.ToString();
                }
            }
            catch
            {
                // Fall back to ToString()
                outboxUrl = currentActor.Outbox?.ToString();
            }

            if (string.IsNullOrWhiteSpace(outboxUrl))
            {
                errorMessage = "Unable to determine outbox URL";
                return;
            }

            var outboxUri = new Uri(outboxUrl);
            
            await foreach (var activity in ActivityPubClient.GetCollectionAsync<Activity>(outboxUri, limit: 20))
            {
                outboxActivities.Add(activity);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load outbox: {ex.Message}";
        }
        finally
        {
            isLoadingOutbox = false;
        }
    }

    private async Task QuickLookup(string alias)
    {
        userAlias = alias;
        await LookupUser();
    }

    private void ClearIdentity()
    {
        IdentityService.ClearIdentity();
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        IdentityService.IdentityChanged += OnIdentityChanged;
    }

    private void OnIdentityChanged(object? sender, EventArgs e)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        IdentityService.IdentityChanged -= OnIdentityChanged;
    }
}
