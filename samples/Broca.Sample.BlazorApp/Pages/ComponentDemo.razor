@page "/demo"
@using Broca.ActivityPub.Components
@using KristofferStrube.ActivityStreams

<PageTitle>ActivityPub Components Demo</PageTitle>

<div class="demo-container">
    <header class="demo-header">
        <h1>ActivityPub Components Demo</h1>
        <p>Explore the capabilities of Broca.ActivityPub.Components</p>
    </header>

    <div class="demo-grid">
        <!-- Actor Search Demo -->
        <div class="demo-card">
            <h2>üîç Actor Search</h2>
            <p>Search for ActivityPub actors across the fediverse.</p>
            
            <ActorBrowser OnActorFound="HandleActorFound">
                <LoadingTemplate>
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <span>Searching...</span>
                    </div>
                </LoadingTemplate>
                <ErrorTemplate Context="error">
                    <div class="error-state">
                        <span class="error-icon">‚ö†Ô∏è</span>
                        <p>@error</p>
                    </div>
                </ErrorTemplate>
            </ActorBrowser>
        </div>

        <!-- Activity Feed Demo -->
        <div class="demo-card">
            <h2>üìã Activity Feed</h2>
            <p>Display activity streams with automatic pagination.</p>
            
            <div class="feed-controls">
                <label>
                    Collection URL:
                    <input type="text" 
                           @bind="selectedFeedUrl" 
                           placeholder="https://mastodon.social/users/username/outbox"
                           class="feed-url-input" />
                </label>
                <button @onclick="UpdateFeed" class="update-button">Load</button>
            </div>

            @if (currentFeedUrl != null)
            {
                <div class="feed-display">
                    <ActivityFeed CollectionUrl="@currentFeedUrl" 
                                 PageSize="5"
                                 UseVirtualization="false">
                        <ActivityTemplate Context="activity">
                            <div class="activity-item">
                                <div class="activity-meta">
                                    <span class="activity-type">@activity.Type</span>
                                    <time>@activity.Published?.ToString("g")</time>
                                </div>
                                @if (activity.Object?.Any() == true)
                                {
                                    <ObjectDisplay Object="@activity.Object.First()" />
                                }
                            </div>
                        </ActivityTemplate>
                    </ActivityFeed>
                </div>
            }
        </div>

        <!-- Profile Viewer Demo -->
        <div class="demo-card">
            <h2>üë§ Profile Viewer</h2>
            <p>View actor profiles with integrated feeds.</p>
            
            <div class="profile-controls">
                <label>
                    Actor Handle:
                    <input type="text" 
                           @bind="profileHandle" 
                           placeholder="user@domain.com"
                           class="handle-input" />
                </label>
                <label>
                    <input type="checkbox" @bind="showProfileOutbox" />
                    Show recent activities
                </label>
            </div>

            @if (!string.IsNullOrEmpty(profileHandle))
            {
                <div class="profile-display">
                    <ActorProfile ActorHandle="@profileHandle" 
                                 ShowOutbox="@showProfileOutbox"
                                 OutboxPageSize="3" />
                </div>
            }
        </div>

        <!-- Collection Loader Demo -->
        <div class="demo-card">
            <h2>üì¶ Collection Loader</h2>
            <p>Generic collection loading with customizable rendering.</p>
            
            <div class="collection-info">
                <p>Load any ActivityPub collection with full control over rendering.</p>
                
                @if (demoCollectionUrl != null)
                {
                    <CollectionLoader TItem="KristofferStrube.ActivityStreams.Object" 
                                     CollectionUrl="@demoCollectionUrl"
                                     PageSize="5"
                                     UseVirtualization="false">
                        <ItemTemplate Context="item">
                            <div class="collection-item">
                                <strong>@item.Type</strong>
                                @if (item.Name?.Any() == true)
                                {
                                    <span>: @item.Name.First()</span>
                                }
                            </div>
                        </ItemTemplate>
                        <EmptyTemplate>
                            <div class="empty-collection">
                                <p>No items in collection</p>
                            </div>
                        </EmptyTemplate>
                    </CollectionLoader>
                }
                else
                {
                    <p class="info-text">Use the feed or profile demos to see collections in action.</p>
                }
            </div>
        </div>
    </div>

    @if (foundActor != null)
    {
        <div class="actor-details-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Actor Details</h3>
                    <button @onclick="CloseActorDetails" class="close-button">√ó</button>
                </div>
                <ActorRenderer Actor="@foundActor" ShowDetails="true" />
            </div>
        </div>
    }
</div>

<style>
    .demo-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .demo-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .demo-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .demo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 2rem;
    }

    .demo-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .demo-card h2 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-size: 1.5rem;
    }

    .demo-card > p {
        color: #666;
        font-size: 0.875rem;
        margin-bottom: 1.5rem;
    }

    .feed-controls, .profile-controls {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .feed-url-input, .handle-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.875rem;
    }

    .update-button, .load-button {
        padding: 0.5rem 1rem;
        background: #0066cc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .update-button:hover {
        background: #0052a3;
    }

    .loading-state, .error-state {
        padding: 1rem;
        text-align: center;
    }

    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #0066cc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .error-state {
        color: #d32f2f;
    }

    .activity-item {
        padding: 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .activity-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.75rem;
    }

    .activity-type {
        background: #e3f2fd;
        color: #1976d2;
        padding: 0.125rem 0.5rem;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .actor-details-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        padding: 1.5rem;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .close-button {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: #666;
    }

    .info-text {
        font-style: italic;
        color: #666;
    }
</style>

@code {
    private string selectedFeedUrl = string.Empty;
    private Uri? currentFeedUrl;
    private Uri? demoCollectionUrl;
    private string profileHandle = string.Empty;
    private bool showProfileOutbox = false;
    private KristofferStrube.ActivityStreams.Object? foundActor;

    private void UpdateFeed()
    {
        if (!string.IsNullOrWhiteSpace(selectedFeedUrl) && Uri.TryCreate(selectedFeedUrl, UriKind.Absolute, out var uri))
        {
            currentFeedUrl = uri;
            demoCollectionUrl = uri;
        }
    }

    private void HandleActorFound(KristofferStrube.ActivityStreams.Object actor)
    {
        foundActor = actor;
    }

    private void CloseActorDetails()
    {
        foundActor = null;
    }
}
